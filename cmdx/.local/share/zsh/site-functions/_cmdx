#compdef cmdx

_cmdx_complete_entries() {
    local prefix="${CMDX_STORE:-$HOME/.config/cmdx/store}"
    local -a entries
    
    # Get all files and directories, format as completion entries
    entries=(${(f)"$(find -L "$prefix" -mindepth 1 2>/dev/null | sed "s#${prefix}/##" | sort)"})
    
    # Use compadd with slash suffix for directories
    local entry fullpath
    for entry in $entries; do
        fullpath="$prefix/$entry"
        if [[ -d "$fullpath" ]]; then
            compadd -Q -S '/' -- "$entry"
        elif [[ -f "$fullpath" ]]; then
            compadd -Q -- "$entry"
        fi
    done
}

_cmdx() {
    local curcontext="$curcontext" state line
    typeset -A opt_args

    local -a subcommands
    subcommands=(
        "init:Initialize the command store"
        "add:Add a new command"
        "show:Show a command"
        "list:List commands (tree view)"
        "ls:List commands (tree view)"
        "find:Fuzzy search commands"
        "copy:Copy command to clipboard"
        "cp:Copy command to clipboard"
        "run:Execute a command"
        "edit:Edit a command in \$EDITOR"
        "remove:Remove a command"
        "rm:Remove a command"
        "move:Move/rename a command"
        "mv:Move/rename a command"
        "export:Export all commands to JSON"
        "import:Import commands from JSON"
        "completions:Generate shell completions"
        "pick:Interactive fuzzy finder"
        "s:Interactive fuzzy finder"
    )

    if (( CURRENT > 2 )); then
        local cmd=${words[2]}
        curcontext="${curcontext%:*:*}:cmdx-$cmd"
        (( CURRENT-- ))
        shift words

        case "$cmd" in
            show|cp|copy|run|edit|rm|remove)
                _arguments -C : \
                    '-c[Show command and confirm before executing]' \
                    '--confirm[Show command and confirm before executing]' \
                    '-f[Skip confirmation / force]' \
                    '--force[Skip confirmation / force]' \
                    '*:command path:_cmdx_complete_entries'
                ;;
            add)
                _arguments -C : \
                    '-e[Single-line explanation]:explanation:' \
                    '--explain[Single-line explanation]:explanation:' \
                    '-f[Overwrite if exists]' \
                    '--force[Overwrite if exists]' \
                    '1:path:_cmdx_complete_entries' \
                    '2:command:'
                ;;
            mv|move)
                _arguments -C : \
                    '1:source:_cmdx_complete_entries' \
                    '2:destination:_cmdx_complete_entries'
                ;;
            ls|list)
                _arguments -C : \
                    '*:path prefix:_cmdx_complete_entries'
                ;;
            find)
                _arguments '1:query:'
                ;;
            export)
                _arguments : \
                    '-o[Output file]:file:_files' \
                    '--output[Output file]:file:_files'
                ;;
            import)
                _arguments : \
                    '-f[Overwrite existing]' \
                    '--force[Overwrite existing]' \
                    '1:input file:_files -g "*.json"'
                ;;
            completions)
                _arguments '1:shell:(bash zsh fish elvish powershell)'
                ;;
            init|pick|s)
                ;;
        esac
    else
        _describe -t commands 'cmdx commands' subcommands
        _arguments : \
            '-h[Print help]' \
            '--help[Print help]' \
            '-V[Print version]' \
            '--version[Print version]'
    fi
}

_cmdx "$@"
